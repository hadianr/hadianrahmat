---
import { info } from "@data";
import Layout from "@layouts/Layout.astro";
import CVAtsPreview from "@components/general/CVAtsPreview.astro";
import MetaHead from "@components/general/MetaHead.astro";
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <MetaHead
      title={"CV - " + info.name}
      description={"Download CV in ATS-friendly format"}
      ogImageUrl={"/assets/images/profile.png"}
    />
    <!-- Lazy load PDF library only when needed -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
  </head>

  <body>
    <Layout>
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8 mt-8">
        <div>
          <h1 class="text-4xl font-bold mb-2">My CV</h1>
          <p class="text-sm text-gray-600 dark:text-gray-400">ATS-friendly format ready for download</p>
        </div>
        
        <!-- Enhanced Download Button -->
        <button id="exportPdfBtn">
          <!-- Download Icon SVG -->
          <svg 
            width="20"
            height="20"
            viewBox="0 0 24 24"
          >
            <path 
              stroke-linecap="round" 
              stroke-linejoin="round" 
              stroke-width="2"
              d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
            />
          </svg>
          <span>Download PDF</span>
          <!-- Loading Spinner (hidden by default) -->
          <svg 
            id="loadingSpinner"
            style="display: none;"
            width="20"
            height="20"
            viewBox="0 0 24 24"
          >
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke-width="4"></circle>
            <path class="opacity-75" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
      </div>

      <div id="tipBox" class="mb-8 p-4 bg-blue-50 dark:bg-blue-500/20 rounded-lg border-2 border-blue-200 dark:border-blue-400">
        <p id="tipText" class="text-sm" style="color: rgb(30, 58, 138);">
          ðŸ’¡ <strong id="tipLabel" style="color: rgb(30, 58, 138);">Tip:</strong> <span id="tipDesc" style="color: rgb(30, 58, 138);">This CV is formatted as ATS-friendly (Applicant Tracking System).
          It uses simple formatting to ensure compatibility with automated resume screening systems.</span>
        </p>
      </div>

      <CVAtsPreview />
    </Layout>
  </body>
</html>

<style>
  /* Button styles that respect dark mode */
  #exportPdfBtn {
    background: #2563eb !important;
    color: white !important;
    padding: 0.75rem 1.5rem !important;
    border-radius: 0.5rem !important;
    font-weight: 600 !important;
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1) !important;
    transition: all 0.3s !important;
    display: flex !important;
    align-items: center !important;
    gap: 0.75rem !important;
    border: none !important;
    cursor: pointer !important;
  }

  #exportPdfBtn:hover {
    background: #1d4ed8 !important;
    box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1) !important;
  }

  /* Dark mode adjustments */
  :global(.dark) #exportPdfBtn {
    background: #3b82f6 !important;
  }

  :global(.dark) #exportPdfBtn:hover {
    background: #2563eb !important;
  }

  #exportPdfBtn span,
  #exportPdfBtn svg {
    color: white !important;
    stroke: white !important;
    fill: none !important;
  }

  /* Tip box styling */
  #tipText, #tipLabel {
    color: rgb(30, 58, 138) !important;
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    #tipText, #tipLabel {
      color: white !important;
    }
  }

  /* PDF-specific styles - ensure company names are visible */
  :global(h3) {
    color: #000000 !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    font-weight: 700 !important;
    font-size: 16px !important;
    line-height: 1.5 !important;
    margin-bottom: 0.25rem !important;
  }
</style>

<script is:inline>
  // Force set tip text color for dark mode
  function updateTipColors() {
    const isDark = document.documentElement.classList.contains('dark');
    const tipText = document.getElementById('tipText');
    const tipLabel = document.getElementById('tipLabel');
    const tipDesc = document.getElementById('tipDesc');
    
    if (isDark) {
      if (tipText) tipText.style.color = 'white !important';
      if (tipLabel) tipLabel.style.color = 'white !important';
      if (tipDesc) tipDesc.style.color = 'white !important';
      // Also update all children
      const allElements = document.getElementById('tipBox').querySelectorAll('*');
      allElements.forEach(el => {
        if (el.textContent && el.textContent.includes('Tip') || el.textContent.includes('ATS')) {
          el.style.color = 'white !important';
        }
      });
    } else {
      if (tipText) tipText.style.color = 'rgb(30, 58, 138)';
      if (tipLabel) tipLabel.style.color = 'rgb(30, 58, 138)';
      if (tipDesc) tipDesc.style.color = 'rgb(30, 58, 138)';
    }
  }
  
  // Run on page load
  document.addEventListener('DOMContentLoaded', updateTipColors);
  
  // Run immediately in case DOM is already loaded
  updateTipColors();
  
  // Listen for theme changes
  const observer = new MutationObserver(updateTipColors);
  observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
</script>

<script is:inline>
  // Lazy load PDF library
  let pdfLibLoaded = false;
  let pdfLibLoading = false;

  async function loadPdfLibrary() {
    if (pdfLibLoaded) return true;
    if (pdfLibLoading) {
      // Wait for existing load to complete
      return new Promise((resolve) => {
        const checkInterval = setInterval(() => {
          if (pdfLibLoaded) {
            clearInterval(checkInterval);
            resolve(true);
          }
        }, 100);
      });
    }

    pdfLibLoading = true;
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
      script.async = true;
      script.onload = () => {
        pdfLibLoaded = true;
        pdfLibLoading = false;
        resolve(true);
      };
      script.onerror = () => {
        pdfLibLoading = false;
        reject(new Error('Failed to load PDF library'));
      };
      document.head.appendChild(script);
    });
  }

  const exportBtn = document.getElementById("exportPdfBtn");
  const loadingSpinner = document.getElementById("loadingSpinner");
  const downloadIcon = exportBtn?.querySelector("svg:first-of-type");
  const buttonText = exportBtn?.querySelector("span");
  
  function setButtonState(loading, text = "Download PDF") {
    if (!loadingSpinner || !downloadIcon || !buttonText || !exportBtn) return;
    
    if (loading) {
      downloadIcon.style.display = "none";
      loadingSpinner.style.display = "block";
      buttonText.textContent = text;
      exportBtn.disabled = true;
      exportBtn.classList.add("opacity-75", "cursor-wait");
    } else {
      loadingSpinner.style.display = "none";
      downloadIcon.style.display = "block";
      buttonText.textContent = text;
      exportBtn.disabled = false;
      exportBtn.classList.remove("opacity-75", "cursor-wait");
    }
  }
  
  if (exportBtn) {
    exportBtn.addEventListener("click", async () => {
      try {
        setButtonState(true, "Loading library...");

        // Lazy load PDF library
        await loadPdfLibrary();
        
        setButtonState(true, "Generating PDF...");

        const element = document.querySelector(".cv-ats");
        if (!element) {
          throw new Error("CV element not found");
        }

        // Optimized PDF options
        const options = {
          margin: [0.4, 0.4, 0.4, 0.4],
          filename: `Hadian_Rahmat_CV_${new Date().getFullYear()}.pdf`,
          image: { 
            type: "jpeg", 
            quality: 0.95 
          },
          html2canvas: { 
            scale: 2,
            useCORS: true,
            letterRendering: true,
            logging: false,
            width: element.scrollWidth,
            height: element.scrollHeight,
            windowWidth: element.scrollWidth,
            windowHeight: element.scrollHeight
          },
          jsPDF: { 
            unit: "in", 
            format: "letter", 
            orientation: "portrait",
            compress: true
          },
          pagebreak: { 
            mode: ['avoid-all', 'css', 'legacy'],
            before: '.page-break-before',
            after: '.page-break-after',
            avoid: ['h2', 'h3', 'section']
          }
        };

        if (typeof html2pdf === "undefined") {
          throw new Error("PDF library failed to load");
        }

        // Generate and download
        await html2pdf().set(options).from(element).save();
        
        // Success feedback
        setButtonState(true, "Downloaded! âœ“");
        setTimeout(() => {
          setButtonState(false, "Download PDF");
        }, 2000);

      } catch (error) {
        console.error("Error exporting PDF:", error);
        setButtonState(false, "Download PDF");
        
        // User-friendly error message
        const errorMsg = error.message.includes('library') 
          ? 'Failed to load PDF library. Please check your connection and try again.'
          : 'Error generating PDF. Please try again.';
        
        alert(errorMsg);
      }
    });
  }

  // Auto-download with improved handling
  document.addEventListener('DOMContentLoaded', () => {
    try {
      const params = new URLSearchParams(window.location.search);
      const shouldDownload = params.get('download') === '1';
      
      if (shouldDownload && exportBtn) {
        // Preload library and trigger download
        loadPdfLibrary().then(() => {
          setTimeout(() => {
            exportBtn.click();
          }, 500);
        }).catch(err => {
          console.error('Failed to preload PDF library:', err);
        });
      }
    } catch (e) {
      console.warn('Failed to parse URL params for auto-download', e);
    }
  });
</script>
