---
import { IExperiences } from "@types";

const { title, details } = Astro.props as IExperiences;

// Group experiences by company
const groupByCompany = (experiences: any[]) => {
  const grouped = new Map();
  experiences.forEach((exp) => {
    const company = exp.company || exp.name;
    if (!grouped.has(company)) {
      grouped.set(company, {
        company,
        city: exp.city,
        roles: []
      });
    }
    grouped.get(company).roles.push(exp);
  });
  return Array.from(grouped.values());
};

const groupedExperiences = groupByCompany(details);

// Function to bold keywords in text - more selective approach
const boldKeywords = (text: string, isBullet: boolean = false) => {
  if (isBullet) {
    // For bullet points with colon: bold everything before the colon
    if (text.includes(':')) {
      const colonIndex = text.indexOf(':');
      const beforeColon = text.substring(0, colonIndex).trim();
      const afterColon = text.substring(colonIndex + 1).trim();
      return `<strong>${beforeColon}:</strong> ${afterColon}`;
    }
    
    // For bullet points without colon: bold specific important keywords
    const importantKeywords = /\b(Developing|Implementing|Leading|Collaborating|Architecting|Designing|Building|Creating|Managing|Optimizing|Enhancing|Maintaining|Ensuring|Leveraging|Utilizing|Establishing|Promoting)\b/g;
    return text.replace(importantKeywords, '<strong>$1</strong>');
  }
  
  // For paragraphs: only bold specific technical terms and important keywords
  const technicalTerms = /\b(Go|Node\.js|PHP|Laravel|Docker|Kubernetes|GKE|CI\/CD|DevOps|OKRs?|KPIs?|Agile|Scrum|Google Cloud|GCP|AWS|Azure|TypeScript|JavaScript|React|Vue|Angular|PostgreSQL|MySQL|Redis|GraphQL|REST|API|Microservices)\b/g;
  
  return text.replace(technicalTerms, '<strong>$1</strong>');
};

// Format date range for company
const formatCompanyDateRange = (roles: any[]) => {
  if (!roles.length) return '';
  const startDate = roles[roles.length - 1].startDate;
  const endDate = roles[0].endDate;
  return `${startDate} - ${endDate}`;
};
---

<section
  id="experience"
  class="flex items-start justify-between flex-col sm:flex-row"
>
  <h2 class="w-[15rem] mt-16">{title}</h2>
  <div class="w-full">
    {
      groupedExperiences.map((group: any) => (
        <div class="my-16">
          <div class="flex justify-between items-center flex-wrap mb-2">
            <h3 class="text-xl font-semibold text-dark-gray dark:!text-white">{group.company}</h3>
            {group.roles.length > 1 && (
              <p class="text-sm text-gray-600 dark:text-gray-400">
                {formatCompanyDateRange(group.roles)}
              </p>
            )}
          </div>
          {group.city && (
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">{group.city}</p>
          )}
          
          {group.roles.map((item: any, index: number) => (
            <div class={index > 0 ? "mt-8" : ""}>
              <div class="flex justify-between items-center flex-wrap">
                <h3 class="text-l font-semibold text-blue dark:!text-white">{item.role || item.location}</h3>
                <p class="text-sm flex items-center gap-2 dark:text-gray-400">
                  <span>
                    {item.startDate} - {item.endDate}
                  </span>
                  {item.employmentType && (
                    <span class="px-2 py-0.5 rounded-full bg-slate-100 text-blue text-xs font-semibold dark:bg-slate-800">
                      {item.employmentType}
                    </span>
                  )}
                </p>
              </div>
              <div class="mt-3 space-y-3">
                {item.description
                  .filter((desc) => !desc.trim().startsWith("-"))
                  .map((paragraph) => (
                    <p class="text-base leading-relaxed">
                      <Fragment set:html={boldKeywords(paragraph, false)} />
                    </p>
                  ))}

                {item.description.some((desc) => desc.trim().startsWith("-")) && (
                  <ul class="list-none pl-5 space-y-2">
                    {item.description
                      .filter((desc) => desc.trim().startsWith("-"))
                      .map((bullet) => (
                        <li class="before:content-['â€¢'] before:mr-2">
                          <Fragment set:html={boldKeywords(bullet.replace(/^[-\s]+/, "").trim(), true)} />
                        </li>
                      ))}
                  </ul>
                )}
              </div>
            </div>
          ))}
        </div>
      ))
    }
  </div>
</section>

<style>
  /* Bullet point color - inherit from parent text color */
  li::before {
    color: inherit;
  }

  /* Bold keyword styling */
  strong {
    font-weight: 600;
  }
  
  /* Force h3 to use proper colors in dark mode */
  :global(.dark) h3 {
    color: rgb(255 255 255) !important;
  }
</style>
