---
import { info } from "@data";

const formatDate = (date: string): string => {
  if (date === "Present") return "Present";
  return date;
};
const groupExperiencesByCompany = (experiences: typeof info.experience) => {
  const map = new Map<string, { company: string; roles: typeof info.experience[number][] }>();
  experiences.forEach((exp) => {
    const company = exp.company || exp.role || "Experience";
    if (!map.has(company)) {
      map.set(company, { company, roles: [] });
    }
    map.get(company)!.roles.push(exp);
  });
  return Array.from(map.values());
};

const formatCompanyRange = (roles: typeof info.experience[number][]) => {
  if (!roles.length) return "";
  const startDate = roles[roles.length - 1]?.startDate ?? roles[0]?.startDate;
  const endDate = roles[0]?.endDate ?? roles[roles.length - 1]?.endDate;
  if (!startDate || !endDate) return "";
  return `${formatDate(startDate)} - ${formatDate(endDate)}`;
};

const groupedExperience = groupExperiencesByCompany(info.experience);
---

<div class="cv-ats max-w-4xl mx-auto p-8 bg-white text-black">
  <!-- Header -->
  <header class="text-center mb-6 border-b-2 border-black pb-4">
    <h1 class="text-3xl font-bold mb-1">{info.name}</h1>
    <p class="text-lg mb-2">{info.jobDescription} | Certified Google Cloud Professional Developer</p>
    <div class="flex justify-center gap-2 text-sm mb-2">
      <span>{info.location}</span>
      <span>|</span>
      <span>{info.website}</span>
    </div>
    <div class="flex justify-center gap-4 text-sm">
      <a
        href={`mailto:${info.socialMedia.email.replace("mailto:", "")}`}
        class="hover:underline"
      >
        {info.socialMedia.email.replace("mailto:", "")}
      </a>
      <span>|</span>
      <a href={info.socialMedia.linkedin} class="hover:underline">
        LinkedIn
      </a>
      <span>|</span>
      <a href={info.socialMedia.github} class="hover:underline">
        GitHub
      </a>
    </div>
  </header>

  <!-- Professional Summary -->
  <section class="mb-6">
    <h2 class="text-xl font-bold mb-3 border-b border-black pb-2 uppercase">
      Professional Summary
    </h2>
    <p class="text-justify text-sm leading-relaxed">{info.cvSummary}</p>
  </section>

  <!-- Technical Skills -->
  <section class="mb-6">
    <h2 class="text-xl font-bold mb-3 border-b border-black pb-2 uppercase">
      Technical Skills
    </h2>
    <div class="grid grid-cols-1 gap-2 text-sm">
      <div class="flex">
        <span class="font-semibold w-48 flex-shrink-0">Languages:</span>
        <span>{info.skills.languages.join(", ")}</span>
      </div>
      <div class="flex">
        <span class="font-semibold w-48 flex-shrink-0">Frameworks:</span>
        <span>{info.skills.frameworks.join(", ")}</span>
      </div>
      <div class="flex">
        <span class="font-semibold w-48 flex-shrink-0">Frontend:</span>
        <span>{info.skills.frontend.join(", ")}</span>
      </div>
      <div class="flex">
        <span class="font-semibold w-48 flex-shrink-0">Databases:</span>
        <span>{info.skills.databases.join(", ")}</span>
      </div>
      <div class="flex">
        <span class="font-semibold w-48 flex-shrink-0">Cloud Platforms:</span>
        <span>{info.skills.cloud.join(", ")}</span>
      </div>
      <div class="flex">
        <span class="font-semibold w-48 flex-shrink-0">DevOps & CI/CD:</span>
        <span>{info.skills.devops.join(", ")}</span>
      </div>
      <div class="flex">
        <span class="font-semibold w-48 flex-shrink-0">Tools & Technologies:</span>
        <span>{info.skills.tools.join(", ")}</span>
      </div>
      <div class="flex">
        <span class="font-semibold w-48 flex-shrink-0">AI-Augmented Tools:</span>
        <span>{info.skills.aiTools.join(", ")}</span>
      </div>
      <div class="flex">
        <span class="font-semibold w-48 flex-shrink-0">Methodologies:</span>
        <span>{info.skills.methodologies.join(", ")}</span>
      </div>
    </div>
  </section>

  <!-- Certifications -->
  <section class="mb-6">
    <h2 class="text-xl font-bold mb-3 border-b border-black pb-2 uppercase">
      Certifications
    </h2>
    {info.certifications.map((cert) => (
      <div class="mb-3">
        <div class="flex justify-between items-start mb-1">
          <h3 class="font-bold text-sm">{cert.name}</h3>
          <span class="text-sm text-gray-700">{cert.date}</span>
        </div>
        <p class="text-sm font-semibold text-gray-800">{cert.issuer}</p>
        {cert.description && (
          <p class="text-sm text-gray-700 mt-1">{cert.description}</p>
        )}
        {cert.credentialUrl && (
          <a href={cert.credentialUrl} class="text-sm text-blue-600 hover:underline mt-1 block">
            View Credential
          </a>
        )}
      </div>
    ))}
  </section>

  <!-- Experience -->
  <section class="mb-6">
    <h2 class="text-xl font-bold mb-3 border-b border-black pb-2 uppercase">
      Experience
    </h2>
    {groupedExperience.map((group) => (
      <div class="mb-4">
        <div class="flex justify-between items-start mb-2">
          <h3 class="font-bold text-sm">{group.company}</h3>
          {group.roles.length > 1 && (
            <span class="text-sm text-gray-700">
              {formatCompanyRange(group.roles)}
            </span>
          )}
        </div>
        {group.roles.map((exp) => (
          <div class="ml-4 mb-4">
            <div class="flex justify-between items-start mb-1">
              <p class="font-semibold text-sm">{exp.role}</p>
              <span class="text-sm text-gray-700">
                {formatDate(exp.startDate)} - {formatDate(exp.endDate)}
              </span>
            </div>
            <div class="flex items-center gap-2 mb-2">
              {exp.employmentType && (
                <span class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-800 text-xs font-semibold border border-gray-300">
                  {exp.employmentType}
                </span>
              )}
            </div>
            {exp.city && <p class="text-xs text-gray-700 mb-2">{exp.city}</p>}
            <div class="text-sm">
              {exp.description.map((desc) => (
                <>
                  {desc.startsWith("-") ? (
                    <div class="ml-4 text-sm">â€¢ {desc.substring(1).trim()}</div>
                  ) : (
                    <p class="mb-2">{desc}</p>
                  )}
                </>
              ))}
            </div>
          </div>
        ))}
      </div>
    ))}
  </section>

  <!-- Education -->
  <section class="mb-6">
    <h2 class="text-xl font-bold mb-3 border-b border-black pb-2 uppercase">
      Education
    </h2>
    {info.education.map((edu) => (
      <div class="mb-4">
        <div class="flex justify-between items-start mb-1">
          <h3 class="font-bold text-sm">{edu.description[0]}</h3>
          <span class="text-sm text-gray-700">
            {edu.startDate} - {edu.endDate}
          </span>
        </div>
        <p class="font-semibold text-sm">{edu.name}</p>
        <p class="text-sm text-gray-700">{edu.location}</p>
      </div>
    ))}
  </section>

  <!-- Languages -->
  <section class="mb-6">
    <h2 class="text-xl font-bold mb-3 border-b border-black pb-2 uppercase">
      Languages
    </h2>
    <div class="grid grid-cols-2 gap-2 text-sm">
      {info.languages.map((lang) => (
        <div class="flex items-center">
          <span class="font-semibold mr-2">{lang.name}:</span>
          <span class="text-gray-700">{lang.proficiency}</span>
        </div>
      ))}
    </div>
  </section>

  <!-- Community Involvement -->
  <section>
    <h2 class="text-xl font-bold mb-3 border-b border-black pb-2 uppercase">
      Community Involvement
    </h2>
    {info.organization.map((org) => (
      <div class="mb-3">
        <div class="flex justify-between items-start mb-1">
          <h3 class="font-bold text-sm">{org.name}</h3>
          <span class="text-sm text-gray-700">
            {org.startDate} - {org.endDate}
          </span>
        </div>
        <p class="text-sm text-gray-700">{org.location}</p>
        {org.description.map((desc) => (
          <p class="text-sm mt-1">{desc}</p>
        ))}
      </div>
    ))}
  </section>
</div>

<script>
  // Client-side PDF export functionality
  window.exportCVAsPDF = async function () {
    const element = document.querySelector(".cv-ats");
    if (!element) {
      console.error("CV element not found");
      return;
    }

    try {
      const html2pdf = (await import("html2pdf.js")).default;

      const options = {
        margin: 0.5,
        filename: `Hadian_Rahmat_CV.pdf`,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
      };

      html2pdf().set(options).from(element).save();
    } catch (error) {
      console.error("Error generating PDF:", error);
    }
  };
</script>

<style>
  .cv-ats {
    font-family: "Calibri", "Arial", sans-serif;
    line-height: 1.4;
  }

  /* Prevent page breaks inside sections */
  .cv-ats section {
    page-break-inside: avoid;
  }

  /* Prevent orphaned headers */
  .cv-ats h2, .cv-ats h3 {
    page-break-after: avoid;
  }

  /* Keep experience entries together */
  .cv-ats .mb-4 {
    page-break-inside: avoid;
  }

  @media print {
    .cv-ats {
      padding: 0;
      margin: 0;
    }
    
    /* Better page break control for print */
    section {
      page-break-inside: avoid;
    }
    
    h2, h3 {
      page-break-after: avoid;
    }
  }
</style>
