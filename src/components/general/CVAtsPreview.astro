---
import { info } from "@data";

const formatDate = (date: string): string => {
  if (date === "Present") return "Present";
  return date;
};
const groupExperiencesByCompany = (experiences: typeof info.experience) => {
  const map = new Map<string, { company: string; roles: typeof info.experience[number][] }>();
  experiences.forEach((exp) => {
    const company = exp.company || exp.role || "Experience";
    if (!map.has(company)) {
      map.set(company, { company, roles: [] });
    }
    map.get(company)!.roles.push(exp);
  });
  return Array.from(map.values());
};

const formatCompanyRange = (roles: typeof info.experience[number][]) => {
  if (!roles.length) return "";
  const startDate = roles[roles.length - 1]?.startDate ?? roles[0]?.startDate;
  const endDate = roles[0]?.endDate ?? roles[roles.length - 1]?.endDate;
  if (!startDate || !endDate) return "";
  return `${formatDate(startDate)} - ${formatDate(endDate)}`;
};

const groupedExperience = groupExperiencesByCompany(info.experience);
---

<div class="cv-ats bg-white text-black">
  <!-- Header -->
  <header class="text-center mb-3 border-b-2 border-black pb-2">
    <h1 class="font-bold mb-1">{info.name}</h1>
    <p class="font-semibold mb-2">{info.jobDescription} | Certified Google Cloud Professional Developer</p>
    <div class="flex justify-center gap-1 mb-2">
      <span>{info.location}</span>
      <span>|</span>
      <span>{info.website}</span>
    </div>
    <div class="flex justify-center gap-2">
      <a
        href={`mailto:${info.socialMedia.email.replace("mailto:", "")}`}
        class="hover:underline"
        aria-label="Email Hadian Rahmat"
      >
        {info.socialMedia.email.replace("mailto:", "")}
      </a>
      <span>|</span>
      <a href={info.socialMedia.linkedin} class="hover:underline" aria-label="LinkedIn profile" rel="noopener noreferrer" target="_blank">
        LinkedIn
      </a>
      <span>|</span>
      <a href={info.socialMedia.github} class="hover:underline" aria-label="GitHub profile" rel="noopener noreferrer" target="_blank">
        GitHub
      </a>
    </div>
  </header>

  <!-- Professional Summary -->
  <section class="mb-3">
    <h2 class="text-xl font-bold mb-1 border-b border-black pb-1 uppercase">
      Professional Summary
    </h2>
    <p class="text-justify leading-relaxed">{info.cvSummary}</p>
  </section>

  <!-- Technical Skills -->
  <section class="mb-3">
    <h2 class="text-xl font-bold mb-1 border-b border-black pb-1 uppercase">
      Technical Skills
    </h2>
    <div class="grid grid-cols-1 gap-1">
      <div class="flex">
        <span class="font-semibold w-48 flex-shrink-0">Languages:</span>
        <span>{info.skills.languages.join(", ")}</span>
      </div>
      <div class="flex">
        <span class="font-semibold w-48 flex-shrink-0">Frameworks:</span>
        <span>{info.skills.frameworks.join(", ")}</span>
      </div>
      <div class="flex">
        <span class="font-semibold w-48 flex-shrink-0">Frontend:</span>
        <span>{info.skills.frontend.join(", ")}</span>
      </div>
      <div class="flex">
        <span class="font-semibold w-48 flex-shrink-0">Databases:</span>
        <span>{info.skills.databases.join(", ")}</span>
      </div>
      <div class="flex">
        <span class="font-semibold w-48 flex-shrink-0">Cloud Platforms:</span>
        <span>{info.skills.cloud.join(", ")}</span>
      </div>
      <div class="flex">
        <span class="font-semibold w-48 flex-shrink-0">DevOps & CI/CD:</span>
        <span>{info.skills.devops.join(", ")}</span>
      </div>
      <div class="flex">
        <span class="font-semibold w-48 flex-shrink-0">Tools & Technologies:</span>
        <span>{info.skills.tools.join(", ")}</span>
      </div>
      <div class="flex">
        <span class="font-semibold w-48 flex-shrink-0">AI-Augmented Tools:</span>
        <span>{info.skills.aiTools.join(", ")}</span>
      </div>
      <div class="flex">
        <span class="font-semibold w-48 flex-shrink-0">Methodologies:</span>
        <span>{info.skills.methodologies.join(", ")}</span>
      </div>
    </div>
  </section>

  <!-- Certifications -->
  <section class="mb-3">
    <h2 class="text-xl font-bold mb-1 border-b border-black pb-1 uppercase">
      Certifications
    </h2>
    {info.certifications.map((cert) => (
      <div class="mb-1.5" style="page-break-inside: avoid;">
        <div class="flex justify-between items-start mb-0.5">
          <h3 class="font-bold">{cert.name}</h3>
          <span class="text-gray-700">{cert.date}</span>
        </div>
        <p class="font-semibold text-gray-800">{cert.issuer}</p>
        {cert.description && (
          <p class="text-gray-700 mt-0.5">{cert.description}</p>
        )}
        {cert.credentialUrl && (
          <a href={cert.credentialUrl} class="text-blue-600 hover:underline mt-0.5 block">
            View Credential
          </a>
        )}
      </div>
    ))}
  </section>

  <!-- Experience -->
  <section class="mb-3">
    <h2 class="text-xl font-bold mb-1 border-b border-black pb-1 uppercase">
      Experience
    </h2>
    {groupedExperience.map((group) => (
      <div class="mb-4" style="page-break-inside: avoid; margin-top: 0.8rem;">
        <div class="flex justify-between items-start mb-1 gap-2">
          <h3 class="font-bold flex-1 pr-2">{group.company}</h3>
          {group.roles.length > 1 && (
            <span class="text-gray-700 whitespace-nowrap">
              {formatCompanyRange(group.roles)}
            </span>
          )}
        </div>
        {group.roles.map((exp) => (
          <div class="ml-4 mb-3" style="page-break-inside: avoid;">
            <div class="flex justify-between items-start mb-1 gap-2">
              <p class="font-semibold flex-1 pr-2">{exp.role}</p>
              <span class="text-gray-700 whitespace-nowrap">
                {formatDate(exp.startDate)} - {formatDate(exp.endDate)}
              </span>
            </div>
            <div class="flex items-center gap-1 mb-2">
              {exp.employmentType && (
                <span class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-800 font-semibold border border-gray-300">
                  {exp.employmentType}
                </span>
              )}
            </div>
            {exp.city && <p class="text-gray-700 mb-2">{exp.city}</p>}
            <div>
              {exp.description.map((desc) => (
                <>
                  {desc.startsWith("-") ? (
                    <div class="ml-4 break-words">â€¢ {desc.substring(1).trim()}</div>
                  ) : (
                    <p class="mb-2 break-words">{desc}</p>
                  )}
                </>
              ))}
            </div>
          </div>
        ))}
      </div>
    ))}
  </section>

  <!-- Education -->
  <section class="mb-3">
    <h2 class="text-xl font-bold mb-1 border-b border-black pb-1 uppercase">
      Education
    </h2>
    {info.education.map((edu) => (
      <div class="mb-2" style="page-break-inside: avoid;">
        <div class="flex justify-between items-start mb-1">
          <h3 class="font-bold">{edu.description[0]}</h3>
          <span class="text-gray-700">
            {edu.startDate} - {edu.endDate}
          </span>
        </div>
        <p class="font-semibold">{edu.name}</p>
        <p class="text-gray-700">{edu.location}</p>
      </div>
    ))}
  </section>

  <!-- Languages -->
  <section class="mb-3">
    <h2 class="text-xl font-bold mb-1 border-b border-black pb-1 uppercase">
      Languages
    </h2>
    <div class="grid grid-cols-2 gap-1 text-[10px] leading-[1.45]">
      {info.languages.map((lang) => (
        <div class="flex items-center">
          <span class="font-semibold mr-2">{lang.name}:</span>
          <span class="text-gray-700">{lang.proficiency}</span>
        </div>
      ))}
    </div>
  </section>

  <!-- Community Involvement -->
  <section class="mb-0">
    <h2 class="text-xl font-bold mb-1 border-b border-black pb-1 uppercase">
      Community Involvement
    </h2>
    {info.organization.map((org) => (
      <div class="mb-2">
        <div class="flex justify-between items-start mb-1">
          <h3 class="font-bold">{org.name}</h3>
          <span class="text-gray-700">
            {org.startDate} - {org.endDate}
          </span>
        </div>
        <p class="text-gray-700">{org.location}</p>
        {org.description.map((desc) => (
          <p class="mt-1">{desc}</p>
        ))}
      </div>
    ))}
  </section>
</div>

<style>
  /* Fixed safe dimensions for PDF export */
  .cv-ats {
    width: 7in;
    max-width: 7in;
    min-height: auto;
    margin: 0.3in auto;
    padding: 0.2in 0.08in;
    font-family: "Inter", "Arial", sans-serif;
    line-height: 1.35;
    font-size: 10px;
    color: #000;
    background: #fff;
    box-sizing: border-box;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .cv-ats h1 {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 0.25rem;
    background: transparent !important;
    background-image: none !important;
    -webkit-text-fill-color: #000 !important;
    color: #000 !important;
    background-clip: unset !important;
    -webkit-background-clip: unset !important;
  }

  /* Header text consistency */
  .cv-ats header p {
    font-size: 11px;
    font-weight: 600;
    margin-bottom: 0.35rem;
  }

  .cv-ats header .text-sm,
  .cv-ats header a,
  .cv-ats header span {
    font-size: 10px;
    font-weight: 500;
  }

  .cv-ats h2 {
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.3px;
    margin-top: 0.8rem;
  }

  .cv-ats h3 {
    font-size: 11px;
    font-weight: 700;
  }

  .cv-ats p,
  .cv-ats span,
  .cv-ats div,
  .cv-ats li {
    font-size: 10px;
    line-height: 1.4;
  }

  /* Prevent page breaks inside sections */
  .cv-ats section {
    page-break-inside: avoid;
    margin-bottom: 0.4rem;
    page-break-before: auto;
  }

  /* Spacing antar section - dikurangi */
  .cv-ats section:not(:first-of-type) {
    padding-top: 0.3rem;
    margin-top: 0.3rem;
  }

  /* Prevent orphaned headers */
  .cv-ats h2,
  .cv-ats h3 {
    page-break-after: avoid;
  }

  /* Keep experience entries together */
  .cv-ats .mb-4,
  .cv-ats .mb-3,
  .cv-ats .mb-2 {
    page-break-inside: avoid;
  }

  @media print {
    .cv-ats {
      margin: 0;
      padding: 0.45in 0.08in 0.2in 0.08in;
      box-shadow: none;
    }

    section {
      page-break-inside: avoid;
    }

    h2, h3 {
      page-break-after: avoid;
    }
  }
</style>
